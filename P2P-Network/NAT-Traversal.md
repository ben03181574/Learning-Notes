#  NAT Traversal

## **目錄**
---
1. [NAT 穿越前景提要](#1-nat-穿越前景提要)
    1. [穿越基本要求](#1-1-穿越基本要求)
    2. [穿越防火牆](#1-2-穿越防火牆)
2. [NAT 穿越各種情況](#2-nat-穿越各種情況)
    1. [NAT 簡單版穿越](#2-1-nat-簡單版穿越)
    2. [NAT 困難版穿越](#2-2-nat-困難版穿越)
    3. [NAT 協定版穿越](#2-3-nat-協定版穿越)
    4. [NAT 保底版穿越](#2-4-nat-保底版穿越)
    5. [NAT 多重版穿越](#2-5-nat-多重版穿越)
    6. [NAT 企業版穿越](#2-6-nat-企業版穿越)
    7. [NAT IPv6版穿越](#2-7-nat-ipv6版穿越)
3. [NAT 穿越實際流程](#3-nat-穿越實際流程)
    1. [ICE 演算法](#3-1-ice-演算法)
---  
<br/>

## **1. NAT 穿越前景提要**
### **1-1. 穿越基本要求**
首先，進行 NAT 穿越時，強烈建議 _使用 UDP 協定_ 。  

其次，需要可以 _直接控制機器在網路上所傳送或接收的封包_（結構如下圖，NAT 穿越與 QUIC 協定於同一層），可以透過使用 Local Proxy 代理來控制封包。
<p>
＋－－－－－－－－－－－－－－－－－－＋<br/>
｜　　　　　ＹＯＵＲ　ＡＰＰ　　　　　｜<br/>
｜－－－－－－－－－－－－－－－－－－｜<br/>
｜　ＱＵＩＣ．．．　｜　ＮＡＴ　穿越　｜<br/>
｜－－－－－－－－－－－－－－－－－－｜<br/>
｜　　　　ＵＤＰ　ＳＯＣＫＥＴＳ　　　｜<br/>
＋－－－－－－－－－－－－－－－－－－＋<br/>
</p>

> 雖然仍然可以使用 TCP 協定進行穿越，但因為其在此層有增加其通訊複雜性，以至於需要修改更底層的設定，因此不建議使用。但如果仍希望有 TCP 此類穩定的連接（stream-oriented），可以使用由 Google 推出得基於 UDP 的 QUIC 協定，其具認證加密功能、低延遲的連接管理、更精確的重送處裡、多重化（可一個連接同時處裡多個串流）、連接遷移（IP位址改變時，如移到其他NAT區段，仍維持連接狀態）。

### **1-2. 穿越防火牆**
在講 NAT 穿越之前，先了解如何穿越防火牆，因為大部分的 NAT 設備也具有防火牆。 

對於 UDP 封包，防火牆會遵循一規則：_當前小段時間有連出（Outbound）UDP 封包，則允許來源目標相反之連入（Inbound）UDP 封包_。 

如下圖，當 PC 先與 Server 傳送封包後，防火牆會允許 Server 回傳給 PC 的封包，除此之外則會拒絕其他 Server 主動傳送之封包。
<hr>
<p>
　　　　　　｜｜　　　　＋－－－＋<br/>
　　　　　　｜Ｘ＜－－－｜　　　｜<br/>
＋－－＋　　｜｜　　　　｜　Ｓ　｜<br/>
｜ＰＣ｜＜＝＝＝＝＝＝＞｜　Ｅ　｜<br/>
＋－－＋　　｜｜　　　　｜　Ｒ　｜<br/>
　　　　　　｜｜　　　　｜　　　｜<br/>
　　　　　　｜｜　　　　＋－－－＋<br/>
</p>
<hr>

而兩端都是 PC 端時，當然可以透過傳統的 Client-Server 架構，傳送給中央的 Server (如 VPN Hub)，由其進行轉發，然而此架構無法使 PC "直接"相連。  

為了讓兩端能夠直接相連，我們可以採取另一種方法同時不需更改防火牆的設定。  

在此之前，我們需要先建立一 Coordination Server 用來讓想要直連的 PC 能夠互通資訊如 IP:Port 和通訊時間等等。接著，其中一方A透過 IP:Port 等資訊先主動傳送封包對方B，然而對方B的防火牆因為先前沒有發送封包給A，因此不允許封包通過（如下圖1）。而近乎同時間B也發送封包給A，而A防火牆會因為不久前曾發送封包給B，因此准許B發送的封包通過（如下圖2），彼此之間開始得以穿透防火牆通訊（如下圖3）。
<hr>
<p>
（１）　　　｜｜　｜｜　　　　　　<br/>
＋－－＋　　｜｜　｜｜　　＋－－＋<br/>
｜ＰＣ｜－－－－＞Ｘ｜　　｜ＰＣ｜<br/>
＋－－＋　　｜｜　｜｜　　＋－－＋<br/>
　　　　　　｜｜　｜｜　　　　　　<br/>
</p>
<hr>
<p>
（２）　　　｜｜　｜｜　　　　　　<br/>
＋－－＋　　｜｜　｜｜　　＋－－＋<br/>
｜ＰＣ｜＜－－－－－－－－｜ＰＣ｜<br/>
＋－－＋　　｜｜　｜｜　　＋－－＋<br/>
　　　　　　｜｜　｜｜　　　　　　<br/>
</p>
<hr>
<p>
（３）　　　｜｜　｜｜　　　　　　<br/>
＋－－＋　　｜｜　｜｜　　＋－－＋<br/>
｜ＰＣ｜＜＝＝＝＝＝＝＝＞｜ＰＣ｜<br/>
＋－－＋　　｜｜　｜｜　　＋－－＋<br/>
　　　　　　｜｜　｜｜　　　　　　<br/>
</p>
<hr>

> 為了讓通訊雙方可以同步資訊我們建立了 Coordination Server，兩端連接至此 Server 之通道我們稱之為"旁信通道"（Side channel）。不過，這種架構並非 Client-Server （Hub-and-Spoke）架構，因為此架構只是交換彼此資訊而並非透過 Server 傳送資料。  

## **2. NAT 穿越各種情況**  
### **2-1. NAT 簡單版穿越**  
與穿越防火牆不同的是，在 NAT 網路中，通訊雙方是不知道自己的公共位址，只知道自己的私有位址。  

此時我們會利用 STUN 協議（Session Traversal Utilities for NAT），PC 端透過訪問 STUN 主機來藉此讓 STUN 主機知道自己的公共位址與埠口並告知 PC 端。得知彼此雙方的公共位址後即可直接穿透彼此 NAT 及防火牆。
> NAT 設備對於每組 IP:Port 都有不同的對應關係，因此過去提到需要可以直接控制封包目的是為了再透過 STUN 取得位址資訊時，可以取得正確的資訊。  

### **2-2. NAT 困難版穿越**  
然而，有些 NAT設備不單單只是直接將私有位址轉成公共位址，有些則是透過私有位址以及傳送目標位址來進行轉換，這導致當我們訪問 STUN 主機時得到一組對應關係，然而，當真正與對方通訊時又得到另一組未知的對應關係，這使得 STUN 協議不可用。

上述設備稱之為 EDM（Endpoint-Dependent Mapping）或者 Symmetric NAT，反之則稱為 EIM（Endpoint-Independent Mapping）或者 Full Cone NAT。  

> 注意的是，如果是屬於[NAT 多重版穿越](#2-5-nat-多重版穿越)架構，只要路線中有一台設備屬於 EDM 則 STUN協議也不可用。  

假設通訊雙方僅一邊屬於EDM，我們可以先透過 STUN 協議取得公共位址（但仍無法取得埠口），再結合[生日悖論演算法]()進行埠口掃描（下方為計算得到埠口資訊之機率的程式碼），即可取得埠口資訊。  
```python
def easy_hard(hard_side_sockets=256, easy_side_probes=256){
    # On the hard side, create N sockets and send probes to the one
    # (known, correct) ip:port on the easy side. The net effect, for
    # the purposes of this simulation, is that we'll have N port
    # mappings on the hard NAT, all wanting to see traffic from the
    # easy ip:port.
    hard_side_ports = set(random.sample(range(1025, 65536), k=hard_side_sockets))

    # On the easy side, create a single socket and probe M ports on
    # the hard side.
    easy_side_probes = set(random.sample(range(1025, 65536), k=easy_side_probes))

    hits = easy_side_probes.intersection(hard_side_ports)
    return len(hits) > 0
}
```

然而，如果通訊雙方皆為EDM，即使透過埠口掃描也需要耗費大量時間，因此建議採取其他方法進行 NAT 穿越，如[NAT 協定版穿越](#2-3-nat-協定版穿越)或者[NAT 保底版穿越](#2-4-nat-保底版穿越)等等。

### **2-3. NAT 協定版穿越** 
當 NAT 設備支持協定如 UPnP IGD（Universal Plug'n'Play Internet Gateway Device）、NAT-PMP（NAT Port Mapping Protocol）或者 PCP（Port Control Protocol），連接端可以透過協定來詢問最靠近自己的 NAT 設備自己所分配到的公共位址與埠口資訊。  
> 然而大部分網管人員為避免資安風險通常會將其協議功能關閉。此外，當遇到某些情境如[NAT 多重版穿越](#2-5-nat-多重版穿越)，透過協定取得之位址埠口資訊是靠近端點，然而我們希望獲得之位址資訊是連接外部網路的 NAT 設備，因此此方法在此架構下不可用。  

### **2-4. NAT 保底版穿越**  
當遇到特殊情況，如某些網路禁止輸出所有除了 DNS 的 UDP 封包，或者所有其他穿越方法皆不可用時，所使用之最終手段。  

我們會利用 TURN（Traversal Using Relay around NAT）協議或者更進階的 DERP（Detoured Encrypted Routing Protocol）進行封包中繼。  

DERP 協議是運行於 HTTPS 協議並進行傳輸，此外，資料於來源端便已加密，中繼設備無從得知資訊，只是單純的轉發封包。DERP 協議用以改良過時的 TURN 協議。
<hr>
<p>
　　　　　｜Ｎ　　＋－＋　｜｜　　　　　<br/>
　＋－－－－Ａ－＞｜Ｒ｜－－－－－－＋　<br/>
　｜　　　｜Ｔ　　＋－＋　｜｜　　　｜　<br/>
＋－－＋　｜｜　　　　　　｜｜　＋－﹀＋<br/>
｜ＰＣ｜　｜｜　　　　　　｜｜　｜ＰＣ｜<br/>
＋－︿＋　｜｜　　　　　　｜｜　＋－－＋<br/>
　　｜　　｜｜　＋－＋　　Ｎ｜　　｜　　<br/>
　　＋－－－－－｜Ｒ｜＜－Ａ－－－＋　　<br/>
　　　　　｜｜　＋－＋　　Ｔ｜　　　　　<br/>
</p>
<hr>

### **2-5. NAT 多重版穿越**  
多重 NAT 設備架構圖如下。此架構下 NAT 穿越只會與公共網路連接的 NAT 設備有關，其餘可以忽略。因此，穿越方法與上述方法中並無衝突，除了[NAT 協定版穿越](#2-3-nat-協定版穿越)。　　  
<hr>
<p>
　　　　　｜｜　｜｜　　｜｜　　　　　<br/>
　　　　　｜｜　｜｜　　｜｜　　　　　<br/>
　　　　　｜｜　｜｜　　｜｜　　　　　<br/>
＋－－＋　｜Ｎ　｜Ｎ　　Ｎ｜　＋－－＋<br/>
｜ＰＣ＜－－Ａ－－Ａ－－Ａ－－＞ＰＣ｜<br/>
＋－－＋　｜Ｔ　｜Ｔ　　Ｔ｜　＋－－＋<br/>
　　　　　｜｜　｜｜　　｜｜　　　　　<br/>
　　　　　｜｜　｜｜　　｜｜　　　　　<br/>
　　　　　｜｜　｜｜　　｜｜　　　　　<br/>
</p>
<hr>

因為在 NAT 多重版穿越架構中，透過協定取得之位址埠口資訊是靠近端點，然而我們希望獲得之位址資訊是連接外部網路的 NAT 設備，因此此方法在此架構下不可用。  

### **2-6. NAT 企業版穿越**  
企業級網路架構中，ISP 業者又會將公共網路切割成諸多 ISP 子網路用來讓更多設備連接，架構圖如下，設計出此架構原因在於 IPv4 位址數量遠不及設備數量導致。而企業級 NAT 設備又稱為 Carrier-Grade NAT（CGNAT）。  
<hr>
<p>
ＬＡＮ１　　　Ｘ　　ＩＳＰ　　｜｜　ＷＡＮ<br/>
　　　　　　＋＋　　　　　　　｜｜　　　　<br/>
＋－－＋　　｜Ｎ　　　　　　　｜｜　　　　<br/>
｜ＰＣ｜－－－Ａ－－－＋　　　｜｜　　　　<br/>
＋－－＋　　｜Ｔ　　　｜　　　｜｜　　　　<br/>
　　　　　　＋＋　　　｜　　　｜｜　　　　<br/>
　　　　　　　Ｘ　　　｜　　　｜｜　　　　<br/>
ＸＸＸＸＸＸＸＸ　　　＋－－－－－－＞　　<br/>
　　　　　　　Ｘ　　　｜　　　｜｜　　　　<br/>
　　　　　　＋＋　　　｜　　　｜｜　　　　<br/>
＋－－＋　　｜Ｎ　　　｜　　　｜｜　　　　<br/>
｜ＰＣ｜－－－Ａ－－－＋　　　｜｜　　　　<br/>
＋－－＋　　｜Ｔ　　　　　　　｜｜　　　　<br/>
　　　　　　＋＋　　　　　　　｜｜　　　　<br/>
ＬＡＮ２　　　Ｘ　　　　　　　｜｜　　　　<br/>
</p>
<hr>

企業級 NAT 可以當作變形的[NAT 多重版穿越](#2-5-nat-多重版穿越)，因此上述方法幾乎皆適用，然而，此架構衍生一問題－當兩個區域網路皆隸屬於同一 ISP 區域網路，代表其所發送之封包不會經過外部公共網路，這導致 STUN 協議不可用，如下圖。
<hr>
<p>
ＬＡＮ１　　　Ｘ　　ＩＳＰ　　｜｜　ＷＡＮ<br/>
　　　　　　＋＋　　　　　　　｜｜　　　　<br/>
＋－－＋　　｜Ｎ　　　　　　　｜｜　　　　<br/>
｜ＰＣ｜－＜－Ａ－＜－＋　　　｜｜　　　　<br/>
＋－－＋　　｜Ｔ　　　｜　　　｜｜　　　　<br/>
　　　　　　＋＋　　　｜　　　｜｜　　　　<br/>
　　　　　　　｜　　　｜　　　｜｜　　　　<br/>
ＸＸＸＸＸＸＸＸ　　　｜　　　｜｜　　　　<br/>
　　　　　　　Ｘ　　　｜　　　｜｜　　　　<br/>
　　　　　　＋＋　　　｜　　　｜｜　　　　<br/>
＋－－＋　　｜Ｎ　　　｜　　　｜｜　　　　<br/>
｜ＰＣ｜－＞－Ａ－＞－＋　　　｜｜　　　　<br/>
＋－－＋　　｜Ｔ　　　　　　　｜｜　　　　<br/>
　　　　　　＋＋　　　　　　　｜｜　　　　<br/>
ＬＡＮ２　　　Ｘ　　　　　　　｜｜　　　　<br/>
</p>
<hr>　　

解決方法可以透過[NAT 協定版穿越](#2-3-nat-協定版穿越)直接詢問位址埠口資訊，然而如果當協議被禁止或者區域網路屬於多重 NAT 結構，導致協定方法不可以，可以改採取 NAT Hairpin 模式。  

如果 CGNAT 設備支援 NAT Hairping 模式，則當底下某區域網路要轉發封包給另一區域網路時，CGNAT 的 Internal（不是面對公網的 Public 接口）接口會直接轉發封包給另一區域網路，此專業術語稱為 Hairping。  

然而當設備不支援 Hairping 時，便只能採取最終的保底方式進行穿越。

### **2-7. NAT IPv6版穿越**  

雖然 IPv6 解決了位址不足的問題，也不需要 NAT 設備支援，但因為目前大約仍有六成，因此目前仍需要 IPv4＋NAT64/DNS64 設備。當 IPv6 專屬網路要與公共網路連接時，需要透過 DNS64/NAT64 設備來進行網域級位址的轉換，使其兩區段能夠互相連通，結構圖如下（DNS64 Resolver / NAT64 Gateway）。  
<hr>
<p>
ＩＰｖ４　　　Ｘ　　ＩＰｖ６　　　<br/>
　　　　　　＋－－＋　　　　　　　<br/>
＋－－＋　　｜Ｎ６｜　　　　　　　<br/>
｜ＰＣ｜－－｜Ａ　｜－－－－－＋　<br/>
＋－－＋　　｜Ｔ４｜　　　　　｜　<br/>
　｜　　　　＋－－＋　　　　　｜　<br/>
　｜　　　　　Ｘ　　　　　　　﹀　<br/>
　－－＞＋－－－－－＋　　＋－－＋<br/>
ＸＸＸＸ｜ＤＮＳ６４｜－＞｜ＰＣ｜<br/>
　－－＞＋－－－－－＋　　＋－－＋<br/>
　｜　　　　　Ｘ　　　　　　　﹀　<br/>
　｜　　　　　Ｘ　　　　　　︿　　<br/>
＋－－＋　　　Ｘ　　　　　　｜　　<br/>
｜ＰＣ｜－－－－－－－－－－＋　　<br/>
＋－－＋　　　Ｘ　　　　　　　　　<br/>
　　　　　　　Ｘ　　　　　　　　　<br/>
ＩＰｖ６　　　Ｘ　　　　　　　　　<br/>
</p>
<hr>  

當設備支援 CLAT（Customer-side transLATor），其讓 OS 假裝自己直接與 IPv4 相連，其實在背後使用 NAT64 使其正常工作。大部分移動設備都具備 CLAT，然而對於伺服器仍不常見。

因此對於不支援 CLAT 裝置，我們需要首先偵測是否存在 DNS64 / NAT64 設備，透過向 _ipv4only.arpa_ 發送 DNS 請求，如果回傳 IPv6 位址則代表其設備存在，反之則不存在。前者必然會用到 NAT64 進行轉換，可以結由回傳位址得知其 IPv6 前綴詞，往後要向 IPv4 位址發送封包時，便可利用格式｛NAT64 prefix + IPv4 Address｝，接著透過 NAT64 網路與 STUN 通訊來獲得 NAT64 在公共網路的位址埠口資訊，即可依照上述方法進行穿透。  

## **3. NAT 穿越實際流程**
### **3-1. ICE 演算法**  
ICE 演算法與 STUN、TURN 類似，來自於電信領域，其充斥諸多電信術語，因此忽略這些術語時，可以發現他的演算法很單純：嘗試所有方法，並選擇最佳的那個方法。  

首先，為了與對方直接通訊，需要先蒐集自己端的位址埠口資訊，須至少包括：
1. 自己本身的 IPv6 IP:Port
1. 自己本身的 IPv4 LAN IP:Port
2. 透過 STUN 協議得知的 IPv4 WAN IP:Port
3. 透過端口映射協議（協定版穿越）得知的 IPv4 WAN IP:Port
4. ISP 業者提供给的 endpoints（如靜態配置的端口轉發）  
接著透過旁信通道與對方互相交換此資訊，並不斷交換 ping 封包，用以檢測特定路徑是否可通，並選擇最佳路徑。